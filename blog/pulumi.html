<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset="utf-8" />
  <meta name="description" content="lol thot leadership" />
  <title>Integration testing your cloud infrastructure with Pulumi and Jest</title>

  <link rel="stylesheet" href="../styles.css">
</head>

<header>
  <nav>
    <ul>
      <li>
        <a href="../index.html">about</a>
      </li>
      <li>
        <a href="index.html">blog</a>
      </li>
      <!-- <li>
        <a>reading</a>
      </li> -->
      <li>
        <a href="https://github.com/immykins">github</a>
      </li>
      <li>
        <a href="https://twitter.com/imogenheapsort">twitter</a>
      </li>
    </ul>
  </nav>
</header>

<body>
  <main>
    <div class="content blog">
      <h1>Integration testing your cloud infrastucture with Pulumi and Jest</h1>
      <p>Pulumi is typescript IaaC. They have a <a href="https://www.pulumi.com/docs/guides/testing/integration/">cool
          thing</a> written in Go, but I really just wanted to use Jest for all of my application testing so I could
        keep everything in a single repo with a single test runner.</p>
      <p>The downside is that it's slow - spinning up and tearing down infrastructure, in the simplest of cases, will
        take over a minute. Tag these tests and only run them before a deployment - they can easily be baked into a
        CI/CD
        system and gate automated deployments.</p>
      <p>Go is very much the <em>lingua franca</em> of cloud infrastructure so I may end up splitting my pulumi code
        out
        and migrating to their integration test framework.</p>
      <pre>
        <code>
import { CognitoUserPool } from '../../src/cognito';
import automation from './automation';

beforeAll(() => {
  return automation.deploy();
});

afterAll(() => {
  return automation.destroy();
});

// in jest, just return a promise and jest will wait for it to resolve
test('create a user pool and user', () => {
  const phoneNumber = '+12025550195';

  return automation
    .getOuputs()
    .then((result) => {
      return new CognitoUserPool({ ClientId: result.clientID.value, UserPoolId: result.poolID.value });
    })
    .then((pool) => {
      return pool.createUser(phoneNumber);
    })
    .then((result) => {
      expect(result.getUsername()).toBe(phoneNumber);
    });
});
        </code>
      </pre>
    </div>
  </main>
</body>